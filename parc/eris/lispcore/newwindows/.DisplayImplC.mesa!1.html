<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>File [eris]&lt;LispCore>NEWWINDOWS>DisplayImplC.mesa!1</title>
  </head>
  <body>
    <pre>
-- Copyright (C) 1983  by Xerox Corporation. All rights reserved. -- DisplayImplC.mesa - last edited by -- Rick	        29-Nov-83 11:51:53  -- Bruce	25-Feb-83 10:35:50  DIRECTORY  BitBlt USING [BitBltFlags],  Display USING [paintGrayFlags],  DisplayFormat USING [CircleType],  DisplayOps USING [LogError],  DisplayInternal USING [SpecialCircle],  SpecialDisplay USING [defaultContext, LineStyle, solid, Special],  Window USING [Box, BoxHandle, nullBox, Place],  WindowOps USING [AbsoluteBoxHandle, Bounds, Object, ScreenBox];DisplayImplC: PROGRAM  IMPORTS DisplayInternal, DisplayOps, SpecialDisplay, WindowOps  EXPORTS Display, DisplayInternal, SpecialDisplay, Window =  BEGIN  -- exported types  Handle: TYPE = LONG POINTER TO Object;  Object: PUBLIC TYPE = WindowOps.Object;  -- copied types because John doesn't like them  Special: TYPE = SpecialDisplay.Special;  Arc: PUBLIC PROC [    window: Handle, place: Window.Place, radius: INTEGER,    startSector, stopSector: CARDINAL, start, stop: Window.Place,    bounds: Window.BoxHandle &larr; NIL] = {    IF ~window.inTree THEN RETURN;    [] &larr; SpArcInternal[      window, FALSE, place, radius, startSector, stopSector, start, stop,      ALL[FALSE], bounds, SpecialDisplay.solid, Display.paintGrayFlags]};  SpArc: PUBLIC PROC [    window: Handle, place: Window.Place, radius: INTEGER,    startSector, stopSector: CARDINAL, start, stop: Window.Place,    bounds: Window.BoxHandle, dashes: SpecialDisplay.LineStyle,     flags: BitBlt.BitBltFlags, context: Special&larr;SpecialDisplay.defaultContext] = {    ENABLE UNWIND =&gt; NULL;    filled: BOOLEAN = context.alloc # NIL;    SpArcInternal[      window, filled, place, radius, startSector, stopSector, start, stop,      ALL[FALSE], bounds, dashes, flags, context]};  SpArcInternal: PROC [    window: Handle, filled: BOOLEAN, place: Window.Place, radius: INTEGER,    startSector, stopSector: CARDINAL, start, stop: Window.Place,     circleType: DisplayFormat.CircleType, bounds: Window.BoxHandle,     dashes: SpecialDisplay.LineStyle,    flags: BitBlt.BitBltFlags, context: Special &larr; SpecialDisplay.defaultContext]={    box1, box2, box3: Window.Box &larr; Window.nullBox;    boundsBox: WindowOps.ScreenBox =       IF bounds = NIL THEN WindowOps.Bounds[window]      ELSE WindowOps.AbsoluteBoxHandle[window, bounds];    IF filled THEN FillArcBoxes[      @box1, @box2, @box3, start, stop, place, radius, boundsBox.top,      boundsBox.bottom]    ELSE DisplayArcBoxes[      @box1, @box2, @box3, start, stop, place, radius, dashes.thickness,      (startSector-1)*8+(stopSector-1)];  -- octants are now 0..7    IF box1 # Window.nullBox THEN DisplayInternal.SpecialCircle[      window: window, place: place, radius: radius, circleType: circleType,      bounds: @box1, dashes: dashes, flags: flags, context: context];    IF box2 # Window.nullBox THEN DisplayInternal.SpecialCircle[      window: window, place: place, radius: radius, circleType: circleType,      bounds: @box2, dashes: dashes, flags: flags, context: context];    IF box3 # Window.nullBox THEN DisplayInternal.SpecialCircle[      window: window, place: place, radius: radius, circleType: circleType,      bounds: @box3, dashes: dashes, flags: flags, context: context] };    DisplayArcBoxes: PUBLIC PROC [    b1, b2, b3: Window.BoxHandle, start,stop,center:Window.Place,    radius, thickness, sum: CARDINAL] = {    box1, box2, box3: WindowOps.ScreenBox &larr; [left:0,right:0,top:0,bottom:0];    bigBox: WindowOps.ScreenBox &larr; [      left: center.x - radius - 1, right: center.x + radius + 1,      top: center.y - radius - 1, bottom: center.y + radius + 1];    littleBox: WindowOps.ScreenBox &larr; [      left: MIN[start.x, stop.x], right: MAX[start.x, stop.x],       top: MIN[start.y, stop.y], bottom: MAX[start.y, stop.y]];    IF thickness &gt; 2 THEN {      bigBox.left &larr; bigBox.left - 1;      bigBox.right &larr; bigBox.right + 1;      bigBox.top &larr; bigBox.top - 1;      bigBox.bottom &larr; bigBox.bottom + 1;      IF littleBox.left &lt; center.x THEN littleBox.left &larr; littleBox.left - 1;      IF littleBox.top &lt; center.y THEN littleBox.top &larr; littleBox.top - 1;      IF littleBox.right &gt; center.x THEN littleBox.right &larr; littleBox.right + 1;      IF littleBox.bottom &gt; center.y THEN littleBox.bottom &larr; littleBox.bottom+1};    --sum &larr; begin*8 + end;   0 to 65, could be passed from the graphic object    -- convert sum to octal to get start and stop octants    -- (eg. 14 = 16 octal or start octant 1 stop octant 6)    SELECT sum FROM      0 =&gt; -- both in octant 0        IF start.y &gt; stop.y OR start.x &gt; stop.x THEN box1 &larr; littleBox	ELSE {	  box1 &larr; box2 &larr; box3 &larr; bigBox;	  box1.top &larr; box2.bottom &larr; box3.bottom &larr; center.y;	  box2.right &larr; start.x;	  box3.left &larr; stop.x};      1, 2, 57, 58 =&gt; { -- 0 to 1, 0 to 2        box1 &larr; box2 &larr; bigBox;        box1.right &larr; box2.left &larr; start.x;        box2.top &larr; stop.y};      3, 4, 59, 60 =&gt; {-- 0 to 3, 0 to 4        box1 &larr; box2 &larr; bigBox;        box1.bottom &larr; box2.top &larr; center.y;	box1.right &larr; start.x;        box2.right &larr; stop.x};      9 =&gt;  -- both in octant 1        IF start.y &gt; stop.y OR start.x &gt; stop.x THEN box1 &larr; littleBox	ELSE {	  box1 &larr; box2 &larr; box3 &larr; bigBox;	  box1.right &larr; box2.left &larr; box3.left &larr; center.x;	  box2.bottom &larr; start.y;	  box3.top &larr; stop.y};      10 =&gt; {-- 1 to 2        box1 &larr; box2 &larr; box3 &larr; bigBox;        box1.right &larr; box2.left &larr; box3.left &larr; center.x;        box2.bottom &larr; start.y;        box3.top &larr; stop.y};       11, 12, 19, 20 =&gt; {        box1 &larr; box2 &larr; bigBox;        box1.right &larr; box2.left &larr; stop.x;        box2.bottom &larr; start.y};      13, 14, 21, 22 =&gt; {-- 1 to 5        box1 &larr; box2 &larr; bigBox;        box1.right &larr; box2.left &larr; center.x;	box1.bottom &larr; stop.y;        box2.bottom &larr; start.y};      18 =&gt;  -- both in octant 2        IF start.y &gt; stop.y OR start.x &lt; stop.x THEN box1 &larr; littleBox	ELSE {	  box1 &larr; box2 &larr; box3 &larr; bigBox;	  box1.right &larr; box2.left &larr; box3.left &larr; center.x;	  box2.bottom &larr; start.y;	  box3.top &larr; stop.y};      24, 31, 32, 39 =&gt; {	box1 &larr; box2 &larr; bigBox;        box1.top &larr; box2.bottom &larr; center.y;	box1.left &larr; start.x;        box2.left &larr; stop.x};      27 =&gt;  -- both in octant 3        IF start.y &gt; stop.y OR start.x &lt; stop.x THEN box1 &larr; littleBox	ELSE {	  box1 &larr; box2 &larr; box3 &larr; bigBox;	  box1.bottom &larr; box2.top &larr; box3.top &larr; center.y;	  box2.left &larr; start.x;	  box3.right &larr; stop.x};      28 =&gt; {        box1 &larr; box2 &larr; box3 &larr; bigBox;        box1.bottom &larr; box2.top &larr; box3.top &larr; center.y;        box2.left &larr; start.x;        box3.right &larr; stop.x};      29, 30, 37, 38 =&gt; {        box1 &larr; box2 &larr; bigBox;        box1.left &larr; box2.right &larr; start.x;        box2.bottom &larr; stop.y};      36 =&gt;  -- both in octant 4        IF start.y &lt; stop.y OR start.x &lt; stop.x THEN box1 &larr; littleBox	ELSE {	  box1 &larr; box2 &larr; box3 &larr; bigBox;	  box1.bottom &larr; box2.top &larr; box3.top &larr; center.y;	  box2.left &larr; start.x;	  box3.right &larr; stop.x};      40, 47, 48, 55 =&gt; {        box1 &larr; box2 &larr; bigBox;        box1.left &larr; box2.right &larr; stop.x;        box2.top &larr; start.y};      41, 42, 49, 50 =&gt; {        box1 &larr; box2 &larr; bigBox;        box1.left &larr; box2.right &larr; center.x;        box2.top &larr; start.y;	box1.top &larr; stop.y};      45 =&gt;  -- both in octant 5        IF start.y &lt; stop.y OR start.x &lt; stop.x THEN box1 &larr; littleBox	ELSE {	  box1 &larr; box2 &larr; box3 &larr; bigBox;	  box1.left &larr; box2.right &larr; box3.right &larr; center.x;	  box2.top &larr; start.y;	  box3.bottom &larr; stop.y};      46 =&gt; {        box1 &larr; box2 &larr; box3 &larr; bigBox;        box1.left &larr; box2.right &larr; box3.right &larr; center.x;        box2.top &larr; start.y;        box3.bottom &larr; stop.y};      54 =&gt;  -- both in octant 6        IF start.y &lt; stop.y OR start.x &gt; stop.x THEN box1 &larr; littleBox	ELSE {	  box1 &larr; box2 &larr; box3 &larr; bigBox;	  box1.left &larr; box2.right &larr; box3.right &larr; center.x;	  box2.top &larr; start.y;	  box3.bottom &larr; stop.y};      56 =&gt; {        box1 &larr; box2 &larr; box3 &larr; bigBox;        box1.top &larr; box2.bottom &larr; box3.bottom &larr; center.y;        box2.right &larr; start.x;        box3.left &larr; stop.x};      63 =&gt;  -- both in octant 7        IF start.y &lt; stop.y OR start.x &gt; stop.x THEN box1 &larr; littleBox	ELSE {	  box1 &larr; box2 &larr; box3 &larr; bigBox;        box1.top &larr; box2.bottom &larr; box3.bottom &larr; center.y;        box2.right &larr; start.x;        box3.left &larr; stop.x};      5, 61 =&gt; {        box1 &larr; bigBox;	box1.right &larr; start.x;	box1.bottom &larr; stop.y};      6, 7, 15 =&gt; {        box1 &larr; littleBox;	box1.top &larr; bigBox.top};      23 =&gt; {        box1 &larr; bigBox;	box1.left &larr; stop.x;	box1.bottom &larr; start.y};      16, 17, 25 =&gt; {        box1 &larr; littleBox;	box1.right &larr; bigBox.right};      33, 34 =&gt; {        box1 &larr; littleBox;	box1.right &larr; bigBox.right;	box1.bottom &larr; bigBox.bottom};      35, 43 =&gt; {        box1 &larr; littleBox;	box1.bottom &larr; bigBox.bottom};      51, 52 =&gt; {        box1 &larr; littleBox;	box1.left &larr; bigBox.left;	box1.bottom &larr; bigBox.bottom};      53 =&gt; {        box1 &larr; littleBox;	box1.left &larr; bigBox.left};      ENDCASE =&gt; box1 &larr; littleBox;	--8, 26, 44, 62             IF box1.top &lt; box1.bottom AND box1.left &lt; box1.right THEN b1&uarr; &larr; [      place: [x: box1.left, y: box1.top],      dims: [w: box1.right - box1.left + 1, h: box1.bottom - box1.top + 1]];    IF box2.top &lt; box2.bottom AND box2.left &lt; box2.right THEN b2&uarr; &larr; [      place: [x: box2.left, y: box2.top],      dims: [w: box2.right - box2.left + 1, h: box2.bottom - box2.top + 1]];    IF box3.top &lt; box3.bottom AND box3.left &lt; box3.right THEN b3&uarr; &larr; [      place: [x: box3.left, y: box3.top],      dims: [w: box3.right - box3.left + 1, h: box3.bottom - box3.top + 1]]};          FillArcBoxes: PUBLIC PROC [    b1, b2, b3: Window.BoxHandle, startPlace, stopPlace, centerPlace:    Window.Place, screenRadius, top, bottom: INTEGER] = {    left: INTEGER = centerPlace.x - screenRadius - 1;    right: INTEGER = centerPlace.x + screenRadius + 1;    sum: CARDINAL &larr; (SELECT TRUE FROM      startPlace.x &lt; centerPlace.x =&gt; 0,      startPlace.x = centerPlace.x AND startPlace.y &gt; centerPlace.y =&gt; 1,      startPlace.x = centerPlace.x AND startPlace.y &lt; centerPlace.y =&gt; 2,      ENDCASE =&gt; 3) +     (SELECT TRUE FROM        stopPlace.x &lt; centerPlace.x =&gt; 0,        stopPlace.x = centerPlace.x AND stopPlace.y &gt; centerPlace.y =&gt; 4,        stopPlace.x = centerPlace.x AND stopPlace.y &lt; centerPlace.y =&gt; 8,        ENDCASE =&gt; 12);    IF startPlace.y &gt; stopPlace.y THEN sum &larr; sum + 16;    SELECT sum FROM      0, 2, 4, 6 =&gt; b1&uarr; &larr; [place: [x: left, y: startPlace.y],	dims: [w: centerPlace.x - left + 1, h: stopPlace.y - startPlace.y + 1]];      11, 13, 25, 27, 29, 31 =&gt; b1&uarr; &larr; [place: [x: centerPlace.x, y:stopPlace.y],        dims: [w: right - centerPlace.x + 1, h:startPlace.y - stopPlace.y + 1]];         8, 10, 12, 14, 24, 28 =&gt; {	b1&uarr; &larr; [place: [x: left, y: startPlace.y],	  dims: [w: centerPlace.x - left + 1, h: bottom - startPlace.y + 1]];	b2&uarr; &larr; [place: [x: centerPlace.x, y: stopPlace.y],	  dims: [w: right - centerPlace.x + 1, h: bottom - stopPlace.y + 1]]};      1, 3, 5, 7, 17, 19 =&gt; {        b1&uarr; &larr; [place: [x: left, y: top],	  dims: [w: centerPlace.x - left + 1, h: stopPlace.y - top + 1]];	b2&uarr; &larr; [place: [x: centerPlace.x, y: top],	  dims: [w: right - centerPlace.x + 1, h: startPlace.y - top + 1]]};      15 =&gt; {        b1&uarr; &larr; [place: [x: left, y: top],	  dims: [w: centerPlace.x - left + 1, h: bottom - top + 1]];	b2&uarr; &larr; [place: [x: centerPlace.x, y: top],	  dims: [w: right - centerPlace.x + 1, h: startPlace.y - top + 1]];	b3&uarr; &larr; [place: [x: centerPlace.x, y: stopPlace.y],	  dims: [w: right - centerPlace.x + 1, h: bottom - stopPlace.y + 1]]};      16 =&gt; {        b1&uarr; &larr; [place: [x: centerPlace.x, y: top],	  dims: [w: right - centerPlace.x + 1, h: bottom - top + 1]];	b2&uarr; &larr; [place: [x: left, y: startPlace.y],	  dims: [w: centerPlace.x - left + 1, h: bottom - startPlace.y + 1]];	b3&uarr; &larr; [place: [x: left, y: top],	  dims: [w: centerPlace.x - left + 1, h: stopPlace.y - top + 1]]};      ENDCASE =&gt; {        DisplayOps.LogError[]; 	RETURN};    IF b1&uarr; # Window.nullBox AND b1.dims.h = 1 AND      (b2&uarr; # Window.nullBox OR b3&uarr; # Window.nullBox) THEN       b1&uarr; &larr; Window.nullBox;    IF b2&uarr; # Window.nullBox AND b2.dims.h = 1 AND      (b1&uarr; # Window.nullBox OR b3&uarr; # Window.nullBox) THEN       b2&uarr; &larr; Window.nullBox;    IF b3&uarr; # Window.nullBox AND b3&uarr;.dims.h = 1 AND      (b1&uarr; # Window.nullBox OR b2&uarr; # Window.nullBox) THEN       b3&uarr; &larr; Window.nullBox};  END.</pre>
  </body>
</html>
