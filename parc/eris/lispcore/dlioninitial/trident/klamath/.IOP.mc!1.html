<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>[eris]&lt;LispCore>DlionInitial>Trident>Klamath>IOP.mc!1</title>
  </head>
  <body>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{File name:  IOP.mc<br> Last Edited by Jim Frandeen: August 20, 1981  4:12 PM: changes for new assembler<br> Last Edited by Sandman: November 7, 1980  3:29 PM</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"> Last Edited by Roy Ogus: July 8, 1980  12:04 AM<br> Description: Microcode to implement the IOP-CPport functions.<br> Author: Roy Ogus<br>}<br>{LOG:<br></span><span class="tab" val="79"></span><span style="font: 8pt serif">-  Created (March 28, 1980  4:08 PM)<br></span><span class="tab" val="79"></span><span style="font: 8pt serif">-  2 click inner loop (from 3 click) (April 3, 1980  10:30 PM)<br></span><span class="tab" val="79"></span><span style="font: 8pt serif">-  reversed sequence of bytes (April 7, 1980  4:07 PM)<br></span><span class="tab" val="79"></span><span style="font: 8pt serif">-  addition of Naked Notify function (July 7, 1980  6:09 PM)<br></span><span class="tab" val="79"></span><span style="font: 8pt serif">-  common code; swapped cmds (November 7, 1980  3:16 PM)<br>}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{NOTES:<br>-  Word counter is used.  Must be an even number of bytes.<br>-  BYTE ORDER:  normal byte order is low byte, high byte.  <br></span><span class="tab" val="79"></span><span style="font: 8pt serif">Read/Write Swapped command data transfer order is high byte, low byte.<br>-  Memory addresses are real.  Buffers are in contiguous real pages.<br>-  The inner loop uses a maximum buffer address as terminator.<br>-  Buffers should not cross 64K boundaries.}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Register usage:<br></span><span class="tab" val="79"></span><span style="font: 8pt serif">rIAd</span><span class="tab" val="79"></span><span style="font: 8pt serif">-</span><span class="tab" val="79"></span><span style="font: 8pt serif">Memory address<br></span><span class="tab" val="79"></span><span style="font: 8pt serif">RHrIAd</span><span class="tab" val="79"></span><span style="font: 8pt serif">-</span><span class="tab" val="79"></span><span style="font: 8pt serif">High memory address<br></span><span class="tab" val="79"></span><span style="font: 8pt serif">rTmp</span><span class="tab" val="79"></span><span style="font: 8pt serif">-</span><span class="tab" val="79"></span><span style="font: 8pt serif">Temp accumulator<br></span><span class="tab" val="79"></span><span style="font: 8pt serif">uData</span><span class="tab" val="79"></span><span style="font: 8pt serif">-</span><span class="tab" val="79"></span><span style="font: 8pt serif">Saved data<br></span><span class="tab" val="79"></span><span style="font: 8pt serif">uBufMax</span><span class="tab" val="79"></span><span style="font: 8pt serif">-</span><span class="tab" val="79"></span><span style="font: 8pt serif">Maximum buffer address}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
</div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">Set[IOPTask, 5];<br>Set[IOPOutMode, 2];</span><span class="tab" val="46"></span><span class="tab" val="46"></span><span style="font: 8pt serif">{IOP port output mode}<br>Set[IOPAWMode, 3];</span><span class="tab" val="46"></span><span class="tab" val="46"></span><span style="font: 8pt serif">{IOP port alwaysWU mode}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{  loaded into L7<br>   COMMANDS:<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">0 - Write Memory Block<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">1 - Read Memory Block<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">2 - Do Naked Notify<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">3 - (unimplemented)<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">4 - (unimplemented)<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">5 - Write Swapped Block<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">6 - Read Swapped Block}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{IOP  Task code}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span style="font: 8pt serif"><br></span><span class="tab" val="46"></span><span style="font: 8pt serif">SetTask[IOPTask], StartAddress[IOPIdle];<br><br>{Top of the IOP code.  The code is started at this point for a new command.<br>  IOP Control should be set to InMode.}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Read in first byte from the IOP port and interpret it as a command}<br>IOPIdle:</span><span class="tab" val="46"></span><span style="font: 8pt serif">CANCELBR[$,0F],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Dispatch}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">Xbus &larr; IOPIData, XDisp,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">L7 &larr; 0, DISP3[IOPCmd],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br><br>{**************************************************************************}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{COMMAND 0:  Write memory block.<br>     Format of transfer (bytes):<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">command (2 bits), low addr (10:17), mid. addr (2:9), high addr (0:1), <br></span><span class="tab" val="46"></span><span style="font: 8pt serif"> low count-1 (8:15), high count-1 (0:7),<br></span><span class="tab" val="46"></span><span style="font: 8pt serif"> low data, high data, .....<br><br>    IOP Control is in InMode}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{return from IOPSub}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp + rIAd,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3, at[0,10,IOPRet];<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
</div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{Read the first byte from the port (low byte).}<br>WFirst:</span><span class="tab" val="46"></span><span style="font: 8pt serif">uBufMax &larr; rTmp,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Store in uBufMax}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; IOPIData, GOTO [WLo3],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {Read in low byte}<br><br>{Write Memory Block Inner Loop}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{High byte.  Or with low byte, flip bytes.  Test for end of buffer.}<br>WHiByte:</span><span class="tab" val="46"></span><span style="font: 8pt serif">[] &larr; rIAd xor uBufMax, ZeroBr,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Check for max. address}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp or IOPIData, BRANCH[$,WLo3Last],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {OR in high byte: Low, High}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp LRot8,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Flip bytes: High, Low} </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Store the word, read in the next low byte.  Check for page crossing as well.}<br>WLo:</span><span class="tab" val="46"></span><span style="font: 8pt serif">MAR&larr; [RHrIAd, rIAd], rIAd&larr;rIAd+1,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Store in memory}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">uData &larr; MDR &larr; rTmp, rTmp &larr; IOPIData, BRANCH [$, WPgCross, 1],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {Read next low byte}<br>WLo3:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp LRot8, GOTO [WHiByte],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Left justify: Low, xxx} </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span style="font: 8pt serif"><br>{This byte is the last byte.  Since we have to do one more click, set AlwaysWakeMode.  Have to put in an extra click to get everything done.  **Try to fix**.  There will be no page crossing, so do the memory reference and then go back to top of the loop.}<br><br>WLo3Last:</span><span class="tab" val="46"></span><span style="font: 8pt serif">IOPCtl &larr; IOPAWMode,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {xx}<br><br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp LRot8,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Flip bytes: High, Low}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">Noop,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">Noop,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3;<br><br>WLoLast:</span><span class="tab" val="46"></span><span style="font: 8pt serif">MAR&larr; [RHrIAd, rIAd+0],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Store in memory}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">uData &larr; MDR &larr; rTmp,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {Store data}<br>IOPDone:</span><span class="tab" val="46"></span><span style="font: 8pt serif">IOPCtl &larr; IOPInMode, GOTO [IOPIdle],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Back to top}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{The previous MAR&larr; instruction generated a page cross branch.  The data was not written.  The Data to be written is saved in uData, and it was not the last data byte, so we will get at least one more wakeup.  Don&rsquo;t read in new data until we are finished with this data.  rIAd is now pointing to the beginning of this page, instead at the beginning of the next page.  We have to still write the last word of the previous page.  We will also put the remap code here later.  rTmp has the next low byte.}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">WPgCross:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd &larr; rIAd + 0FF,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Point to last address in page}<br><br>{No page cross possible on next instruction.}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">MAR&larr; [RHrIAd, rIAd+0],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Store saved byte}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">MDR &larr; uData,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {in last location on page}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd&larr;rIAd+1,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Incr. address to new page} </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
</div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{Remap code here later.}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">Noop,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">GOTO [WLo3],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br><br>{**************************************************************************}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{COMMAND 1:  Read memory block.<br>     Format of transfer (bytes):<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">command (4 bits), low addr (10:17), mid. addr (2:9), high addr (0:1),<br></span><span class="tab" val="46"></span><span style="font: 8pt serif"> low count-1 (8:15), high count-1 (0:7)<br></span><span class="tab" val="46"></span><span style="font: 8pt serif"> =&gt; returns:   low data, high data, .....<br><br>    IOP Control is in InMode}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Read the low address (10:17)}<br>CReadMem:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd &larr; IOPIData, CALL[IOPSubc2],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1, at [1,4,IOPCmd];<br><br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp + rIAd + 1, IOPCtl &larr; IOPOutMode,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3, at[1,10,IOPRet];<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span style="font: 8pt serif">{We will wakeup here since the data register is empty, and the port is in OutMode.  The IOP task will continue to wakeup until a byte is output to the port.  Data is sent to the port high byte first, then low byte.  At this point RHrIAd is set up with addr[0:1], rIAd with addr[2:17], rTmp has address of last word in buffer + 1.}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Fetch the first word from the buffer.}<br>RFirst:</span><span class="tab" val="46"></span><span style="font: 8pt serif">MAR &larr; [RHrIAd, rIAd], rIAd &larr; rIAd + 1,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Read word}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">uBufMax &larr; rTmp, BRANCH [$, RPgCrFirst, 1],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {Store in uBufMax}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; MD,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Read Memory Block Inner Loop}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Low byte.  Output Low byte of word.}<br>RLoByte:</span><span class="tab" val="46"></span><span style="font: 8pt serif">IOPOData &larr; rTmp LRot0,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; <br></span><span class="tab" val="46"></span><span style="font: 8pt serif">Noop,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">[] &larr; rIAd xor uBufMax, ZeroBr,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Check for max. address}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Process the high byte.  Check for page crossing as well.}<br>RHi:</span><span class="tab" val="46"></span><span style="font: 8pt serif">MAR &larr; [RHrIAd, rIAd], rIAd&larr;rIAd+1, BRANCH[$,RHi2Last],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Read next word}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">IOPOData &larr; rTmp LRot8, BRANCH [$, RPgCross, 1],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {Output low byte}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; MD, GOTO [RLoByte],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Read next word}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span style="font: 8pt serif"><br>{This byte is the last byte.  The next address might have generated a page crossing, but we don&rsquo;t need to worry about it.  Just cancel it, and then go back to top of the loop.}<br><br>RHi2Last:</span><span class="tab" val="46"></span><span style="font: 8pt serif">IOPOData &larr; rTmp LRot8, CANCELBR [IOPDone, 2],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {Output low byte}<br><br>{The first MAR&larr; instruction generated a page cross branch.  rIAd is now pointing to the begining of this page, instead at the beginning of the next page.  Catch the first memory data, fix up rIAd to the correct address and continue.  We will also put the remap code here later.}<br><br>RPgCrFirst:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; MD, GOTO [RPgCr1],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Save memory data}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span style="font: 8pt serif"><br>{The previous MAR&larr; instruction generated a page cross branch.  rIAd is now pointing to the begining of this page, instead at the beginning of the next page.  Catch the last memory data, fix up rIAd to the correct address and continue.  We will also put the remap code here later.}<br><br>RPgCross:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; MD,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Save memory data}<br><br>RPgCr1:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd &larr; rIAd + 0FF + 1,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Increment page number}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">Noop,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {Saved byte}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">GOTO [RLoByte],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Increment pointer}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{**************************************************************************}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{COMMAND 2:  Do Naked Notify.<br>     Format of command:<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">command (2 bits), low interrupt mask, high interrupt mask.<br><br>    IOP Control is in InMode}<br><br>{return from IOPSub with mask in rTmp; need to do another click}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">IOPCtl &larr; IOPAWMode,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3, at[2,10,IOPRet];<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{OR into wakeup U-register.  This must be done in one click.}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd &larr; uWP, MesaIntRq,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp or rIAd, IOPCtl &larr; IOPInMode,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">uWP &larr; rTmp, GOTO [IOPIdle],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3;<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{**************************************************************************}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{COMMAND 3:  (unimplemented)}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">Command3:</span><span class="tab" val="46"></span><span style="font: 8pt serif">Noop,</span><span class="tab" val="46"></span><span class="tab" val="46"></span><span style="font: 8pt serif">c1, at[3,10,IOPCmd];<br>IOPNoCmd:</span><span class="tab" val="46"></span><span style="font: 8pt serif">GOTO[IOPDone],</span><span class="tab" val="46"></span><span class="tab" val="46"></span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;<br><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{**************************************************************************}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{COMMAND 4:  (unimplemented)}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">Command4:</span><span class="tab" val="46"></span><span style="font: 8pt serif">GOTO[IOPNoCmd],</span><span class="tab" val="46"></span><span class="tab" val="46"></span><span style="font: 8pt serif">c1, at[4,10,IOPCmd];<br><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{**************************************************************************}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{COMMAND 5:  Write Swapped Block}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">WriteSwapped:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd &larr; IOPIData, CALL[IOPSubc2],</span><span class="tab" val="46"></span><span class="tab" val="46"></span><span style="font: 8pt serif">c1, at[5,10,IOPCmd];<br><br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp + rIAd,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3, at[5,10,IOPRet];<br><br></span><span class="tab" val="46"></span><span style="font: 8pt serif">uBufMax &larr; rTmp, GOTO[WSHighx],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1;<br><br>{Write Swapped Block Inner Loop}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{Read and left justify high byte.  Test for end of buffer}<br>WSHigh:</span><span class="tab" val="46"></span><span style="font: 8pt serif">[] &larr; rIAd xor uBufMax, ZeroBr,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1;<br>WSHighx:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; IOPIData, BRANCH[$,WSLast],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp LRot8,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Process low byte.  Check for page crossing as well.}<br>WSLo:</span><span class="tab" val="46"></span><span style="font: 8pt serif">MAR&larr; [RHrIAd, rIAd], rIAd&larr;rIAd+1,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; MDR &larr; rTmp or IOPIData, BRANCH[$, WSCross, 1],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">uData &larr; rTmp, GOTO [WSHigh],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{This byte is the last byte.  There will be no page crossing, so do the memory reference and then go back to top of the loop.}<br><br>WSLast:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp LRot8,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {xx}<br><br></span><span class="tab" val="46"></span><span style="font: 8pt serif">MAR&larr; [RHrIAd, rIAd+0],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">MDR &larr; rTmp or IOPIData, GOTO[IOPDone],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;<br><br>{The previous MAR&larr; instruction generated a page cross branch.  The data was not written.  The Data to be written is saved in uData, and it was not the last data byte, so we will get at least one more wakeup.  Don&rsquo;t read in new data until we are finished with this data.  rIAd is now pointing to the beginning of this page, instead at the beginning of the next page.  We have to still write the last word of the previous page.  We will also put the remap code here later.  rTmp has the next low byte.}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">WSCross:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd &larr; rIAd + 0FF,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Point to last address in page}<br><br>{No page cross possible on next instruction.}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">MAR&larr; [RHrIAd, rIAd+0],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; <br></span><span class="tab" val="46"></span><span style="font: 8pt serif">MDR &larr; rTmp,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd&larr;rIAd+1, GOTO[WSHigh],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{**************************************************************************}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{COMMAND 6:  Read Swapped Block}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">ReadSwapped:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd &larr; IOPIData, CALL[IOPSubc2],</span><span class="tab" val="46"></span><span class="tab" val="46"></span><span style="font: 8pt serif">c1, at[6,10,IOPCmd];<br><br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp + rIAd + 1, IOPCtl &larr; IOPOutMode,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3, at[6,10,IOPRet];<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span style="font: 8pt serif">{We will wakeup here since the data register is empty, and the port is in OutMode.  The IOP task will continue to wakeup until a byte is output to the port.  Data is sent to the port high byte first, then low byte.  At this point RHrIAd is set up with addr[0:1], rIAd with addr[2:17], rTmp has address of last word in buffer + 1.}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Fetch the first word from the buffer.}<br>RSFirst:</span><span class="tab" val="46"></span><span style="font: 8pt serif">MAR &larr; [RHrIAd, rIAd], rIAd &larr; rIAd + 1,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Read word}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">uBufMax &larr; rTmp, BRANCH[$, RSCrFirst, 1],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {Store in uBufMax}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; MD,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Read Memory Block Inner Loop}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Low byte.  Output Low byte of word.}<br>RSHigh:</span><span class="tab" val="46"></span><span style="font: 8pt serif">IOPOData &larr; rTmp LRot8,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; <br></span><span class="tab" val="46"></span><span style="font: 8pt serif">uData &larr; rTmp,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">[] &larr; rIAd xor uBufMax, ZeroBr,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Check for max. address}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Process the high byte.  Check for page crossing as well.}<br>RSLo:</span><span class="tab" val="46"></span><span style="font: 8pt serif">MAR &larr; [RHrIAd, rIAd], rIAd&larr;rIAd+1, BRANCH[$,RSHi2Last],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Read next word}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">IOPOData &larr; uData, BRANCH[$, RSCross, 1],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; MD, GOTO[RSHigh],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span style="font: 8pt serif"><br>{This byte is the last byte.  The next address might have generated a page crossing, but we don&rsquo;t need to worry about it.  Just cancel it, and then go back to top of the loop.}<br><br>RSHi2Last:</span><span class="tab" val="46"></span><span style="font: 8pt serif">IOPOData &larr; uData, CANCELBR [IOPDone, 2],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {Output low byte}<br><br>{The first MAR&larr; instruction generated a page cross branch.  rIAd is now pointing to the begining of this page, instead at the beginning of the next page.  Catch the first memory data, fix up rIAd to the correct address and continue.  We will also put the remap code here later.}<br><br>RSCrFirst:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; MD, GOTO [RSCr1],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Save memory data}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span style="font: 8pt serif"><br>{The previous MAR&larr; instruction generated a page cross branch.  rIAd is now pointing to the begining of this page, instead at the beginning of the next page.  Catch the last memory data, fix up rIAd to the correct address and continue.  We will also put the remap code here later.}<br><br>RSCross:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; MD,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Save memory data}<br><br>RSCr1:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd &larr; rIAd + 0FF + 1,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Increment page number}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">Noop,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {Saved byte}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">GOTO [RSHigh],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c3; {Increment pointer}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
</div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{**************************************************************************<br>Address and count fetching subroutine<br>**************************************************************************}<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif">{Read the low address (10:17)}<br>IOPCmd:<br>IOPSubc1:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd &larr; IOPIData,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1, at [0,10,IOPCmd];<br>IOPSubc2:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd &larr; rIAd LRot8,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {low, xxx}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">Noop,</span><span class="tab" val="46"></span><span class="tab" val="46"></span><span class="tab" val="46"></span><span style="font: 8pt serif">c3;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Read the middle address (2:9)}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd &larr; rIAd or IOPIData,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1; {Low, High}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rIAd &larr; rIAd LRot8,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {High, Low}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">Noop,</span><span class="tab" val="46"></span><span class="tab" val="46"></span><span class="tab" val="46"></span><span style="font: 8pt serif">c3;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Read the high address (0:1) into RHrIAd}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">RHrIAd &larr; IOPIData,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">Noop,</span><span class="tab" val="46"></span><span class="tab" val="46"></span><span class="tab" val="46"></span><span style="font: 8pt serif">c2;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">Noop,</span><span class="tab" val="46"></span><span class="tab" val="46"></span><span class="tab" val="46"></span><span style="font: 8pt serif">c3;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span style="font: 8pt serif"><br>{Next comes the next parameter.  It is count-1 for write and read and mask for naked notify.}</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{Read the low}<br>IOPSub2:</span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; IOPIData,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1, at[2,10,IOPCmd];<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp LRot8,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {Left justify}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">Noop,</span><span class="tab" val="46"></span><span class="tab" val="46"></span><span class="tab" val="46"></span><span style="font: 8pt serif">c3;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 8pt serif"><br>{OR in the high}<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp or IOPIData, L7Disp,</span><span class="tab" val="46"></span><span style="font: 8pt serif">c1;<br></span><span class="tab" val="46"></span><span style="font: 8pt serif">rTmp &larr; rTmp LRot8, RET[IOPRet],</span><span class="tab" val="46"></span><span style="font: 8pt serif">c2; {Flip bytes}<br><br><br>{****** Still to be added:<br>  -  page mapping}</span></div>
<script>function do_tabs() { // unit = px
  var tabs = document.getElementsByClassName("tab");
  for (var i = 0; i < tabs.length; ++i) {
    var span = tabs[i];
    var val = span.getAttribute("val");
    if (val == null) console.log("Couldn't get val");
    var rect = span.getBoundingClientRect();
    var tabstop;
    if (val > 0) tabstop = Math.ceil(rect.left / val) * val;
    else tabstop = -val;
    console.log("do_tabs", val, tabstop)
    if (tabstop > 0) {
      var width = tabstop - rect.left;
      span.style.display = "inline-block";
      span.style.width = width + "px";
    }
  }
}
do_tabs();
</script>
  </body>
</html>
