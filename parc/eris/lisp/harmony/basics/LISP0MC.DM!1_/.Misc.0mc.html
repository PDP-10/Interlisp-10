<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>[eris]&lt;Lisp>Harmony>BASICS>LISP0MC.DM!1>Misc.0mc</title>
  </head>
  <body>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">:TITLE[Misc.0mc...January 21, 1983  10:30 AM, van Melle];<br><br>* ReadPrinterPort<br>* Push Printer input as a smallp<br><br>@ReadPrinterPort:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&+1 &larr; (Smallpl), opcode[164];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; Printer, goto[PushTChkP5];<br><br>* WritePrinterPort<br>* Printer &larr; TOS as smallp<br><br>@WritePrinterPort:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">loadpage[pgArithOps], opcode[165];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lspUfn &larr; 165c, call[CheckSmallp];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Printer &larr; Stack, goto[nxiLBL];<br><br><br><br>MC[MiscMax, IFE[WithPPBlt, 0, 4, 5]];</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* Max misc alpha + 1<br><br>@MISC1:</span><span class="tab" val="67"></span><span style="font: 10pt serif">lspUFN &larr; 170c, goto[MiscDispatch], opcode[170];<br><br>@MISC2:</span><span class="tab" val="67"></span><span style="font: 10pt serif">loadpage[pgHStack], call[CheckElt2P5], opcode[171];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lspUFN &larr; 171c, goto[MiscDispatch];<br><br></span><span class="tab" val="67"></span><span style="font: 10pt serif">onpage[opPage1];<br>MiscDispatch:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; NextData[IBuf];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lspLN &larr; T, loadpage[pgMisc];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lu &larr; (lspLN) - (MiscMax);<br>onpage[pgMisc];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Dispatch[lspLN, 15, 3], skip[alu&gt;=0];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">  disp[@STARTIO];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">goto[ufnLBL];<br><br><br>:IF[With10MB];<br>@STARTIO:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; Stack&-1, at[MiscDisp, 0];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lu &larr; Stack&+1, loadpageExternal[StartIOPage];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">RTemp1 &larr; (Zero) xnor T, gotoExternal[StartIOLoc];<br>:ELSE;<br>@STARTIO: goto[ufnLBL], at[MiscDisp, 0];<br>:ENDIF;<br><br>@INPUT:</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">*TOS is Task[10:13], IOReg#[14:17], as smallp<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; Stack&-1, at[MiscDisp, 1];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Input[Stack], goto[nxiLBL];</span><span class="tab" val="67"></span><span style="font: 10pt serif">* Might want to check smallp[TOS]<br><br><br>@OUTPUT:</span><span class="tab" val="67"></span><span style="font: 10pt serif">* TOS as for Input, TOS-1 is smallp value to output<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; Stack&-2, at[MiscDisp, 2];</span><span class="tab" val="67"></span><span style="font: 10pt serif">* Might want to check smallp[TOS]<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Output[Stack];</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* Now need 5 mi til task to avoid gotcha<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&+1;</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* restore stack<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">goto[Misc2ret];</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* dillydally<br>Misc2ret:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">StkState &larr; rsh[StkState, 1], goto[nxiLBL];<br><br>@SETMP:</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* TOS is smallp number to put in MP<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; Stack&-1, loadpageExternal[PNIPPage], at[MiscDisp, 3];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lu &larr; Stack&+1, CallExternal[PNIPLoc];<br>Misc1ret:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">NextOpCode;<br><br>:IF[WithPPBlt];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">onpage[pgMisc];<br>@@PPBLT:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">loadpage[opPage3], at[MiscDisp, 4];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lspL4 &larr; 400c, call[GetVal&Base]; * smallp(TOS) in L1, base in lspGenBr<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lspInstFlag &larr; (InPPBltState);<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&+2, call[ppLP];</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* Point Stack at bytecount<br>ppLP:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lu &larr; Stack, skip[R Even];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">  PFetch1[lspGenBr, lspL0, 0], goto[ppByte2];</span><span class="tab" val="67"></span><span style="font: 10pt serif">* odd count, start with right byte<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lu &larr; Printer, goto[ppExit, alu=0];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">PFetch1[lspGenBr, lspL0, 0], skip[alu&gt;=0];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">  T &larr; lspGenBr, dblgoto[ppInterrupt, ppRet, IntPending];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; rsh[lspL0, 10];</span><span class="tab" val="67"></span><span style="font: 10pt serif">* left byte<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lspL2 &larr; T;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Printer &larr; lspL2;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">nop;</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* Need 300ns between changes<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Printer &larr; lspL4;</span><span class="tab" val="67"></span><span style="font: 10pt serif">* constant 400<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack &larr; (Stack) - 1;</span><span class="tab" val="67"></span><span style="font: 10pt serif">* allow a mi before &larr;Printer for signal propagation?<br>ppByte2:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lu &larr; Printer;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lspL0 &larr; rhmask[lspL0], skip[alu&gt;=0];</span><span class="tab" val="67"></span><span style="font: 10pt serif">* Right byte<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">  T &larr; lspGenBr, dblgoto[ppInterrupt, ppRet, IntPending];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; lspGenBr &larr; (lspGenBr) + 1;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Printer &larr; lspL0, skip[Carry&rsquo;];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">  lspGenBrHi &larr; (lspGenBrHi) + 1;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">nop;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Printer &larr; lspL4;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack &larr; (Stack) - 1, dblgoto[ppInterrupt, ppRet, IntPending];<br><br>ppRet:</span><span class="tab" val="67"></span><span style="font: 10pt serif">return;<br><br>ppInterrupt:</span><span class="tab" val="67"></span><span style="font: 10pt serif">* T = lspGenBr here<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&-2 &larr; T;</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* Fault could be happening here, but its<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* cleanup will do exactly the same thing, so<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* no harm in modifying stack here<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; rsh[lspGenBrHi, 10];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&-1 &larr; T, loadpage[opPage0];</span><span class="tab" val="67"></span><span style="font: 10pt serif">* After third mi after PFetch1<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&+3, gotop[TakeInterrupt];<br><br>ppExit:</span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&-2, loadpage[opPage3];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lspInstFlag &larr; (NormalState), gotop[PopState1];<br><br><br>ppFault:</span><span class="tab" val="67"></span><span style="font: 10pt serif">* Here from page fault.<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* Just like interrupt, but page constraints prevent sharing<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; rsh[lspGenBrHi, 10], at[FaultDisp, InPPBltState!];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&-3 &larr; T;</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* Store Hi base<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; lspGenBr;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&+1 &larr; T;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&+2, goto[lspDoFault];<br>%<br><br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&-2, loadpage[opPage0];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; (Stack&-1) + T;<br>onpage[opPage0];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack &larr; (Stack) + 1, UseCOutAsCIn;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&+1 &larr; T, goto[TakeInterrupt];<br>%<br>:ENDIF;<br><br>:IF[WithPilotBitBlt];<br>@PBITBLT:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">LoadPage[pgHStack], call[CheckElt2P5], opcode[166];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; Stack&-2;</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* look at second arg<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">RTemp &larr; T, goto[bbRestart, alu#0];</span><span class="tab" val="67"></span><span style="font: 10pt serif">* initially zero<br>bbResume:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; Stack&-1;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">bbArgLo &larr; T, loadPage[pgBitBlt];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; lsh[Stack, 10];<br>onpage[pgBitBlt];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; (rhmask[Stack&+1]) + T + 1;</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* build hi base reg<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">bbArgHi &larr; T, goto[LispBitBlt];<br><br></span><span class="tab" val="67"></span><span style="font: 10pt serif">onpage[opPage1];<br>bbRestart:</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* Fetch 8 regs that we stashed away on interrupt<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; (BitBltStash);<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">PFetch4[MDS, uBuf], task;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">RTemp &larr; (Zero) - 1;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; add[BitBltStash!, 4]c;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">PFetch4[MDS, qBuf];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; uBuf;</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* get the guy that missed the quad buf<br></span><span class="tab" val="67"></span><span style="font: 12pt serif">bbDestBitOffset</span><span style="font: 10pt serif"> &larr; T, goto[bbResume];<br><br></span><span class="tab" val="67"></span><span style="font: 10pt serif">onpage[pgBitBlt];<br>BitBltInterrupt:</span><span class="tab" val="67"></span><span style="font: 10pt serif">* come here when IntPending during bitblt<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack&+2 &larr; T, call[BitBltSaveState];</span><span class="tab" val="67"></span><span style="font: 10pt serif">* Odd placement<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">loadpage[opPage0];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">gotop[TakeInterrupt];<br><br><br></span><span class="tab" val="67"></span><span style="font: 10pt serif">onpage[pgLisp0];<br>bbTakeFault:</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* Pagefault fixup routine.  Stkp has already been<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">* restored<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; AllOnes, loadpage[pgBitBlt], at[FaultDisp, InBitBltState!];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Stack &larr; T, callp[BitBltSaveState];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">goto[lspDoFault]<br><br><br></span><span class="tab" val="67"></span><span style="font: 10pt serif">onpage[pgBitBlt];<br>BitBltSaveState:</span><span class="tab" val="67"></span><span style="font: 10pt serif">* Save 8 bitblt regs in MDS space<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; add[BitBltStash!, 4]c;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">PStore4[MDS, qBuf];<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; </span><span style="font: 12pt serif">bbDestBitOffset</span><span style="font: 10pt serif">;</span><span class="tab" val="67"></span><span style="font: 10pt serif">* this guy didn&rsquo;t fit into uBuf quad, sigh<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">uBuf &larr; T;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">T &larr; (BitBltStash);<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">PStore4[MDS, uBuf], return;<br><br>:ELSE;<br>@PBITBLT:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">lspUFN &larr; 166c, goto[lspUfnxP5], opcode[166];<br>:ENDIF;<br></span></div>
<script>function do_tabs() { // unit = px
  var tabs = document.getElementsByClassName("tab");
  for (var i = 0; i < tabs.length; ++i) {
    var span = tabs[i];
    var val = span.getAttribute("val");
    if (val == null) console.log("Couldn't get val");
    var rect = span.getBoundingClientRect();
    var tabstop;
    if (val > 0) tabstop = Math.ceil(rect.left / val) * val;
    else tabstop = -val;
    console.log("do_tabs", val, tabstop)
    if (tabstop > 0) {
      var width = tabstop - rect.left;
      span.style.display = "inline-block";
      span.style.width = width + "px";
    }
  }
}
do_tabs();
</script>
  </body>
</html>
