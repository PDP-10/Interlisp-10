<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>[eris]&lt;Lisp>Harmony>DlionInitial>Trident>Sierra>COREINITIAL.MC!1</title>
  </head>
  <body>
    <div style="width: 491pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">{File name:  CoreInitial.mc<br> Description: 2MB Purcell Core of the initial microcode booting sequence,<br> Last Edited: Purcell   2-Mar-84  5:16:02 remove Bank &larr; 4<br>Last Edited: Purcell 15-Feb-84  1:29:59 recognize 4mb<br> Last Edited: Purcell February 6, 1984  12:29 PM MCtl &larr; 8002h or xx<br> Last Edited: Purcell January 19, 1984  7:25 PM Mesa ignore xtra mem<br> Last Edited: Purcell January 16, 1984  6:35 PM test for 4MB<br> Last Edited: Purcell January 4, 1984  6:46 PM Bank &larr; 4{21 bit real mem}<br> Last Edited: Purcell December 30, 1983  11:17 AM MCtl &larr; 2. <br> Last Edited: Purcell December 29, 1983  5:00 PM 3-8MB mem. <br> Last Edited: Purcell December 27, 1983  9:14 PM 2MB mem. <br> Last Edited: Neely, April 2, 1982  6:28 PM @ TridentInit elim use of U0400.<br> Last Edited: Neely, December 11, 1981  9:59 AM Eliminated mapZap subr.<br> Last Edited: Neely, November 13, 1981  3:47 PM Added Trident Switch.<br> Last Edited: Jarvis, March 21, 1981  8:39 AM<br> Created: Jarvis, November 12, 1980}<br><br>Reserve[ProtectStart, ProtectFence], Reserve[0FE0, 0FFF];</span><span class="tab" val="79"></span><span style="font: 10pt serif">{save room for boot kernel}<br><br>{IO page offsets}<br>Set[DPYCtlWord, 0EC];  {8000=&gt; turn display off}<br><br>{Set[realBankCnt, 0C];{1.5}<br>Set[realBankCnt, 10];{2.0}<br>Set[realBankCnt, 0A0];<br>Set[realBankCnt, 08F];<br>}<br>Set[realBankCnt, 090];<br><br>Set[realBankCntM1, Sub[realBankCnt, 1]];<br>SetTask[0], StartAddress[go];<br><br>go:</span><span class="tab" val="79"></span><span style="font: 10pt serif">{MCtl &larr;} rB{&larr; 8002h} &larr;  RRot1 5, CANCELBR[$, 0F],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IOPCtl&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br>IfGreater[Config,1,SkipTo[TridentInit],];<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">KCtl&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;  {SAx000}<br>SkipTo[NoTridentInit];<br><br>TridentInit!<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">RCnt &larr; 0F,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;  {Trident}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">KCtl &larr; RCnt LRot12,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;  {Trident}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR &larr; 4,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;  {Trident}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">KCmd &larr; acR LRot8,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;  {Trident}<br><br>NoTridentInit!<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DCtl&larr; 3,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1; {display black, enable task}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">PCtl&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EICtl&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EOCtl&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; 40,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; acR LRot8,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IOPageLow&larr; acR,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MCtl{&larr; 8002h} &larr; rB, rB &larr; 4{21 bit real mem},</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop{Bank &larr; rB}, {GOTO[mapInit],}</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>{*}</span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; uDiagnostic,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br>{*}</span><span class="tab" val="79"></span><span style="font: 10pt serif">[]&larr; acR{uDiagnostic} - 1, ZeroBr,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Q &larr; 55{Mesa}, BRANCH[qMBoot, qLBoot],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>qLBoot:</span><span class="tab" val="79"></span><span style="font: 10pt serif">[]&larr; Q xor uLispBootMsg, ZeroBr,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop, BRANCH[rLBoot, rMBoot],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br>rMBoot:</span><span class="tab" val="79"></span><span style="font: 10pt serif">uDiagnostic&larr; 0, GOTO[qMBoot],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br>rLBoot:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>qMBoot:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB &larr; 0AA{Lisp},</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">uLispBootMsg &larr; rB,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop, GOTO[mapInit],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>{map initialization goes on during this interval}<br><br>mapRet:<br>{clear all but the first two pages of bank 0}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">passTraps&larr; acR,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rD&larr; 2,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rD&larr; rD LRot8,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rDrh&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>clear:</span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rDrh, rD+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MDR&larr; acR, rD&larr; rD+1, ZeroBr,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BRANCH[clear, $],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; 0FF+1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">uBootStart&larr; acR, GOTO[OnceOnlyInit],{%}</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>trapIt:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop, GOTO[trapIt],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c*;<br><br>{OnceOnlyInit transfers control to DoneOnceOnlyInit.  DoneOnceOnlyInit lives in the device specific initial microcode.  When that finishes, control passes to exitToEmulator.}<br><br>exitToEmulator:<br><br>{swap entries for IO page and 0}<br>mapIO:</span><span class="tab" val="79"></span><span style="font: 10pt serif">rE&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rErh&larr; 1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; virtualIOPage, L0&larr; 0F,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rBrh&larr; 1, CALL[memSwap2],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1, at[0F, 10, subrRet];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br><br>{make sure the display is off when the germ starts}<br>DPYOff:</span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; RShift1 0, SE&larr; 1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3; {acR&larr; 8000}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rE&larr; IOPageLow,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1; {IOPage real address}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rBrh&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rErh, DPYCtlWord+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MDR&larr; acR,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br><br><br>enableIOP:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rBrh, 0+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MDR&larr; 0FF,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rBrh, 0+1],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MDR&larr; uBootStart, CANCELBR[$, 0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IOPCtl&larr; IOPInMode, GOTOABS[IdleLoc],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>{subroutines and end matter}<br><br>{Map initialization -- Sets up map and leaves next available page in topPage.  Start looking for pages before 768K, i.e., below bank 0C.  Does not map any pages in bank 0.<br><br>Beware -- clobbers the first word of each page in bank 0 even though you don&rsquo;t mean it!!!!!!!!!!!!!!!!!!!!!!!!<br><br>Write page number in the first word of each page.  Go through memory top down to give lower addresses precedence<br><br>Register usage<br>acR</span><span class="tab" val="79"></span><span style="font: 10pt serif">page number<br>rB</span><span class="tab" val="79"></span><span style="font: 10pt serif">memory address register<br>rC</span><span class="tab" val="79"></span><span style="font: 10pt serif">temporary<br>rD</span><span class="tab" val="79"></span><span style="font: 10pt serif">temporary<br>rE</span><span class="tab" val="79"></span><span style="font: 10pt serif">next available page}</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br><br>mapInit:</span><span class="tab" val="79"></span><span style="font: 10pt serif">rBrh&larr; realBankCnt{C}, {start in bank 90{B}}</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB{0}&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2; {address within bank}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">passTraps&larr; acR xor ~acR,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3; {catch faults}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; realBankCnt,{start in bank 90{0F}{B}}</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; acR LRot8, GOTO[mark1],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2; {page counter}<br><br>{mark the first word of each page with its page number}<br>markPages:</span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rBrh, rB+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MDR&larr; acR, ZeroBr,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br>mark1:</span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; acR-1, {NegBr,} BRANCH[$, mapBuild1],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3; {written all pages?}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rC&larr; 0FF+1, {BRANCH[$, mapBuild],}</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rC&larr; rB-rC, CarryBr,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; rC, BRANCH[$, markPages],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; rBrh,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; rB-1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rBrh&larr; rB LRot0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; rC,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">GOTO[markPages],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>mapBuild:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br>mapBuild1:</span><span class="tab" val="79"></span><span style="font: 10pt serif">rBrh&larr; 1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rC&larr; rCrh&larr; 1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>{make all pages vacant}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rBrh, rB+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MDR&larr; vacant,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; mapPages,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; acR LRot8, L0&larr; 0A,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; acR-1, CALL[BLT3],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1, at[0A, 10, subrRet];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rE&larr; 0, {start at virtual 0}</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rErh&larr; 1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3; {map in bank 1}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rBrh&larr;1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1; {so is the IO page}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; IOPageLow,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; rB LRot8,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3; {start mapping pages . . . }<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; acR+0FF+1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1; {IO page is in bank 1}<br><br>{page should have its own page number in the first location}<br>mapLoop2:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br>mapLoop:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br>mapLoop1:</span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rBrh, rB+0], CANCELBR[$,1],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rC&larr; MD, {double  error bit error possible here}</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[]&larr; rC xor acR, ZeroBr,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; acR+1, BRANCH[nextReal, $],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>{map this page in}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">topPage&larr; rB,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; rB or rBrh,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1; {map entry for this page}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif; color: cyan">rC&larr; rB,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; to</span><span style="font: 10pt serif; color: cyan">pPage,</span><span class="tab" val="213"></span><span style="font: 10pt serif; color: cyan">c</span><span style="font: 10pt serif">3</span><span style="font: 10pt serif; color: cyan">;</span><span style="font: 10pt serif; color: brown"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rErh, rE+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MDR&larr; r</span><span style="font: 10pt serif; color: cyan">C or present,</span><span class="tab" val="213"></span><span style="font: 10pt serif; color: cyan">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rE&larr; rE+1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br>nextReal:</span><span class="tab" val="79"></span><span style="font: 10pt serif; color: cyan">rC</span><span style="font: 10pt serif">&larr; 0FF+1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; rB+rC, CarryBr,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Q&larr; rBrh, BRANCH[$, nextBank],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop, GOTO[mapLoop2],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br><br>nextBank:</span><span class="tab" val="79"></span><span style="font: 10pt serif">rC&larr; </span><span style="font: 10pt serif; color: cyan">Q+</span><span style="font: 10pt serif">1, PgCarryBr,  c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rBrh&larr; rC LRot0, BRANCH[$, clearMem3],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Q&larr; uDiagnostic,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[]&larr; Q{uDiagnostic} - 1, ZeroBr{uD=1},</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[]&larr; rC xor 0C, ZeroBr, BRANCH[$, mapLoop1],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop, BRANCH[mapLoop2, clearMem2],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br><br>{clear all mapped pages}<br>clearMem2:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br>clearMem3:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br>clearMem:</span><span class="tab" val="79"></span><span style="font: 10pt serif">topPage&larr; rE,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1; {save away}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rE&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2; {word offset}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rD&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3; {source of zero}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">passTraps&larr; rD, {die on double bit errors}</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>clearLoop:</span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rErh, rE+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1; {read the map}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rC&larr; 0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; MD,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; acR {and 0F},</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rBrh&larr; rB LRot0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; acR and ~0FF,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>{write into every word of the page}<br>clearPage:</span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rBrh, rC+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MDR&larr; rD, rC&larr; rC+1, PgCarryBr,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; topPage, BRANCH[clearPage, $],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rE&larr; rE+1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[]&larr; rE xor acR, ZeroBr,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2; {compare to topPage}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BRANCH[clearLoop, $],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">GOTO[mapRet],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br><br>{trap catcher, gets here with rC&larr; RRot1 ErrnIBnStkp}<br>error:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Xbus&larr; rC LRot0, XwdDisp,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2, at[ErrorHandlerLoc];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DISP2[errorType],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">GOTO[death], {control store parity error}</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1, at[0, 4, errorType];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Xbus&larr; MStatus, XLDisp, GOTO[memFault],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1, at[1, 4, errorType];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">GOTO[death], {stack error}</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1, at[2, 4, errorType];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">GOTO[death], {instruction buffer empty}</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1, at[3, 4, errorType];<br>death:</span><span class="tab" val="79"></span><span style="font: 10pt serif">GOTO[death],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c*;<br><br>memFault:</span><span class="tab" val="79"></span><span style="font: 10pt serif">BRANCH[death, $, 1],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2; {map out of bound?}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">GOTO[nextReal],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3; {no, double bit error}<br><br>{block transfer, takes count in acR, from in rB, and to in rC, returns first word past from block in rE}<br>BLT2:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br>BLT3:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br>BLT:</span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rBrh, rB+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[]&larr; acR, ZeroBr,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rE&larr; MD, BRANCH[$, endBLT],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rCrh, rC+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MDR&larr; rE,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; acR-1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rB&larr; rB+1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rC&larr; rC+1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">GOTO[BLT],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br>endBLT:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br>endBLT1:</span><span class="tab" val="79"></span><span style="font: 10pt serif">pRet0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br>endBLT2:</span><span class="tab" val="79"></span><span style="font: 10pt serif">RET[subrRet],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br><br>{******* Not used anymore<br>{takes count in acR, virtual page number in rE, and map entry in rC.  Beware, rErh better have a 1 !!!!}<br>mapZap3:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br>mapZap:</span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rErh, rE+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MDR&larr; rC or present,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2; {referenced and present}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rC&larr; rC+0FF+1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rE&larr; rE+1,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; acR-1, ZeroBr,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BRANCH[mapZap, $],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br>endMisc1:</span><span class="tab" val="79"></span><span style="font: 10pt serif">pRet0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br>endMisc2:</span><span class="tab" val="79"></span><span style="font: 10pt serif">RET[miscRet],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br>*********}<br>{swaps two locations in memory, takes address in rE and rB, clobbers acR}<br>memSwap2:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br>memSwap3:</span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br>memSwap:</span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rErh, rE+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Noop,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; MD,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rBrh, rB+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MDR&larr; acR,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">acR&larr; MD,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MAR&larr; [rErh, rE+0],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c1;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MDR&larr; acR, pRet0,</span><span class="tab" val="79"></span><span style="font: 10pt serif">c2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">RET[subrRet],</span><span class="tab" val="79"></span><span style="font: 10pt serif">c3;</span></div>
<script>function do_tabs() { // unit = px
  var tabs = document.getElementsByClassName("tab");
  for (var i = 0; i < tabs.length; ++i) {
    var span = tabs[i];
    var val = span.getAttribute("val");
    if (val == null) console.log("Couldn't get val");
    var rect = span.getBoundingClientRect();
    var tabstop;
    if (val > 0) tabstop = Math.ceil(rect.left / val) * val;
    else tabstop = -val;
    console.log("do_tabs", val, tabstop)
    if (tabstop > 0) {
      var width = tabstop - rect.left;
      span.style.display = "inline-block";
      span.style.width = width + "px";
    }
  }
}
do_tabs();
</script>
  </body>
</html>
