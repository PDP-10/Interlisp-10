<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>[eris]&lt;Lisp>Harmony>uCode>STAMPVERSIONS.DM!1>Stampversions.bcpl</title>
  </head>
  <body>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">// StampVersions.bcpl.  Puts version numbers into .eb files.<br>// Created December 21, 1982  4:43 PM by Bill van Melle<br><br></span><span class="tab" val="67"></span><span style="font: 10pt serif">get "AltoFileSys.d"<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">get "Streams.d"<br><br>external [</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">// O.S. procedures<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Resets; Closes; CreateDiskStream; OpenFile<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">Endofs; Gets; Puts; SetFilePos; Wss<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">CallSwat<br><br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">// OS statics <br></span><span class="tab" val="67"></span><span style="font: 10pt serif">fpComCm; fpRemCm<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">]<br><br>static</span><span class="tab" val="67"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">dontGiveUp = false<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">]<br><br>manifest [<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">LispVersionStart = #200<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">]<br><br>structure String: [ length byte; char&uarr;1,255 byte ]<br><br><br>let StampVersions() be<br>[<br>// Read command line: format is<br>// StampVersions &lt;filename&gt; &lt;RamVersion&gt; &lt;MinBcplForRam&gt; &lt;MinLispForRam&gt;<br><br>let name = vec 80<br>let comFile = CreateDiskStream(fpComCm, ksTypeReadOnly, charItem)<br>ReadToken(comFile, name)</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">// skip over "StampVersions.run "<br>ReadToken(comFile, name)<br>let ebFile = OpenFile(name, ksTypeReadWrite, wordItem)<br>if ebFile eq 0<br>   then GiveUp (name, " -- file not found")<br>let RamVersion = ReadNumber(comFile)<br>let MinBcplForRam = ReadNumber(comFile)<br>let MinLispForRam = ReadNumber(comFile)<br>Closes(comFile)<br>SetFilePos(ebFile, 0, LispVersionStart)<br>Puts(ebFile, RamVersion)<br>Puts(ebFile, MinBcplForRam)<br>Puts(ebFile, MinLispForRam)<br>Closes(ebFile)<br>finish<br>]<br><br>and ReadToken(st, body) = valof<br>[<br>let bodylen = 0<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">[</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">// begin loop<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">let ch = Endofs(st)? $*N, Gets(st)<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">switchon ch into<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">   [<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">   case $*S: case $*N:</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">// end of token<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">if bodylen gr 0<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">   then [ body&gt;&gt;String.length = bodylen<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">  resultis body<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">if Endofs(st)<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">   then GiveUp ("Premature end of command line")<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">endcase<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">   default:<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">bodylen = bodylen+1<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">body&gt;&gt;String.char&uarr;bodylen = ch<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">   ]<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">] repeat<br><br> ]<br><br>and ReadNumber(st) = valof<br>[<br>let charfound = false<br>let result = 0<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">[</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">// begin loop<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">let ch = Endofs(st)? $*N, Gets(st)<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">switchon ch into<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">   [<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">   case $*S: case $*N:</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">// end of token<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">if charfound<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">   then resultis result<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">if Endofs(st)<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">   then GiveUp ("Premature end of command line")<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">endcase<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">   default:<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">if (ch ls $0) % (ch gr $7)<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">   then [<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">let str = vec 2<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">str&gt;&gt;String.length = 1<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">str&gt;&gt;String.char&uarr;1 = ch<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">GiveUp("Invalid character in octal constant: ",<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">str)<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">charfound = true<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">result = (result lshift 3) + (ch - $0)<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">   ]<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">] repeat<br><br> ]<br><br>and GiveUp(str1, str2; numargs na) be<br>   [<br>   let st = dontGiveUp? 0, CreateDiskStream(fpRemCm, ksTypeWriteOnly, charItem)<br>   test st<br>      ifso [ Resets(st)<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">     Wss(st, "// ")</span><span class="tab" val="67"></span><span style="font: 10pt serif">// write str on rem.cm for cleaner crash<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">     Wss(st, str1)<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">     if (na gr 1) & str2 & (str2!0)<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt serif">then Wss(st, str2)<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">     Wss(st, "*N")<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">     Closes(st)<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">     finish<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">   ]<br>     ifnot CallSwat (str1, str2)<br>   ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"><br></span></div>
<script>function do_tabs() { // unit = px
  var tabs = document.getElementsByClassName("tab");
  for (var i = 0; i < tabs.length; ++i) {
    var span = tabs[i];
    var val = span.getAttribute("val");
    if (val == null) console.log("Couldn't get val");
    var rect = span.getBoundingClientRect();
    var tabstop;
    if (val > 0) tabstop = Math.ceil(rect.left / val) * val;
    else tabstop = -val;
    console.log("do_tabs", val, tabstop)
    if (tabstop > 0) {
      var width = tabstop - rect.left;
      span.style.display = "inline-block";
      span.style.width = width + "px";
    }
  }
}
do_tabs();
</script>
  </body>
</html>
