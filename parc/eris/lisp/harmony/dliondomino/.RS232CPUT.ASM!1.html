<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>[eris]&lt;Lisp>Harmony>DLionDomino>RS232CPUT.ASM!1</title>
  </head>
  <body>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">{File: RS232CPut.asm<br>Modification History:<br>Last change by Jim Frandeen :  September 8, 1982  3:08 PM: Zero Success bit in case or error. Change handling of Abort.<br>Last change by Jim Frandeen :  July 30, 1982  1:33 PM: new IO Page Format<br>Created  by Jim Frandeen : March 26, 1982  8:23 AM<br>}<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Get</span><span class="tab" val="79"></span><span style="font: 10pt serif">"SysDefs"</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Get</span><span class="tab" val="79"></span><span style="font: 10pt serif">"CommonDefs"</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Get</span><span class="tab" val="79"></span><span style="font: 10pt serif">"RS232CDefs"</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">CheckCPDmaComplete</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From CPSubs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">CurrentSyncCount</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From RS232CMisc<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">DisableTxCRC1</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;From BisyncInterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">DoNakedNotify</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From MultiTask<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">LastTxBufferAddressHigh</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From RS232CInterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">LastTxBufferAddressHigh1</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From RS232CInterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">LastTxBufferAddressLow</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From RS232CInterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">LastTxBufferAddressLow1</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From RS232CInterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PortBusyFlag</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;From CPSubs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutCompletedFlag</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From RS232CInterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutFinishedSwitch</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From RS232CInterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">ReadCPBuffer</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From CPSubs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">RS232CMode</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From RS232CMisc<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">RS232CPutFlag</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From BookKeepingTask<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">RS232CTaskWakeMask</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From RS232CMisc<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">StartCPReadDma</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From CPSubs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">SyncCharacterCount</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From BisyncInterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBisyncInitial</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From BisyncInterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBuffer</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From Buffer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBufferPointer</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From RS232CInterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBisyncStateSwitch</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From BisyncInterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxWR1</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From RS232CMisc<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxWR5</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From RS232CMisc<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">WriteCPBuffer</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From CPSubs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">ZeroCommand</span><span class="tab" val="79"></span><span style="font: 10pt serif">;From CPSubs<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EXP</span><span class="tab" val="79"></span><span style="font: 10pt serif">AbortPutFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EXP</span><span class="tab" val="79"></span><span style="font: 10pt serif">IllegalBisyncCharacterFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EXP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutAsyncMode<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EXP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutBisyncMode<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EXP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutSdlcMode<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EXP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutModeSwitch<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EXP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskResumeAddress<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EXP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskQuiet<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EXP</span><span class="tab" val="79"></span><span style="font: 10pt serif">RestartSIOCharacter<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EXP</span><span class="tab" val="79"></span><span style="font: 10pt serif">StartPutTask<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EXP</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxUnderrunDetectedFlag<br>;<br>RS232CPutTask:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DB</span><span class="tab" val="79"></span><span style="font: 10pt serif">opJMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">;JMP PutTaskYield<br>PutTaskResumeAddress:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskQuiet</span><span class="tab" val="79"></span><span style="font: 10pt serif">;Set by Misc Off Command<br>;</span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">StartPutTask</span><span class="tab" val="79"></span><span style="font: 10pt serif">;Set by Misc SetParameters Command<br>;</span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">FetchPutIocb<br>;</span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">WaitForPutBlock<br>;</span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">WaitForAsyncPut<br>;</span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">WaitForSdlcPut<br>;</span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">WaitForBisyncPut<br>;</span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">TerminateTransmit<br><br>RS232CPutCSB:</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br>PutIOCBAddressPointerLo:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DS</span><span class="tab" val="79"></span><span style="font: 10pt serif">2</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;14031<br>PutIOCBAddressPointerHi:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DS</span><span class="tab" val="79"></span><span style="font: 10pt serif">2</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;14032<br><br>{Put IOCB: this IOCB is copied from the CP into this buffer. When the IOCB has been processed, it is sent back to the CP.}<br>PutIocbBuffer:<br>PutBufferAddressLo:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">0</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">; Virtual Address of Put Buffer<br>PutBufferAddressHi:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">0<br>PutByteCount:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">0</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">; Size of Data in bytes<br>PutDataByteCount:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">0</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">; Number of bytes actually sent.<br>PutTransferStatus:</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DB</span><span class="tab" val="79"></span><span style="font: 10pt serif">0<br>PutTransferStatusHi:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DB</span><span class="tab" val="79"></span><span style="font: 10pt serif">0<br>PutIocbSize</span><span class="tab" val="79"></span><span style="font: 10pt serif">EQU</span><span class="tab" val="79"></span><span style="font: 10pt serif">10<br><br>{Port Control Block to read and write the above IOCB}<br>PutIocbPCB:<br>PutPCBAddressLo:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">0</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">; Address of IOCB in CP memory<br>PutPCBAddressHi:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">0<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutIocbSize</span><span class="tab" val="79"></span><span style="font: 10pt serif">;Size of IOCB in bytes<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutIocbBuffer</span><span class="tab" val="79"></span><span style="font: 10pt serif">; points to IOCB above<br><br>{Port Control Block to send CSB back to CP}<br>ReadPutPCB:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">RS232CPutCSBLoc</span><span class="tab" val="79"></span><span style="font: 10pt serif">; Address in IO Page<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">CPIOPageHi</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">RS232CPutCSBSize</span><span class="tab" val="79"></span><span style="font: 10pt serif">; Size of CSB (in bytes)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">RS232CPutCSB</span><span class="tab" val="79"></span><span style="font: 10pt serif">; Pointer to IOP Buffer<br><br>{Port Control Block to Zero Put Flag}<br>ZeroPutFlag:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">RS232CPutFlagLoc; Address in IO Page<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">CPIOPageHi</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">2</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">; Size of CSB (in bytes)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">ZeroCommand</span><span class="tab" val="79"></span><span style="font: 10pt serif">; Pointer to IOP Buffer<br><br>{PortControlBlock to read block of data from the CP.}<br>TxBlockPCB:<br>TxBlockAddressLo:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">0</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;Address Of Buffer in Main Memory<br>TxBlockAddressHi:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">0<br>TxBlockByteCount:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">0</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;Transfer data Count (in bytes)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBuffer</span><span class="tab" val="79"></span><span style="font: 10pt serif">;Read into TxBuffer<br>;<br>StartPutTask:<br>{Come here when the Misc On Command sets the resume address to start this task.}<br><br>FetchPutIocb:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LDA</span><span class="tab" val="79"></span><span style="font: 10pt serif">RS232CPutFlag</span><span class="tab" val="79"></span><span style="font: 10pt serif">; Check if bit 0 #0 (full)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ORA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">; Set Flags<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JNZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">ReadPutCSB<br><br>{Nothing to do since the Put Flag is not on. Turn off AbortPutFlag in case Misc is waiting for it.}<br>PutTaskQuiet:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XRA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">AbortPutFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskYield<br><br>ReadPutCSB:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LDA</span><span class="tab" val="79"></span><span style="font: 10pt serif">PortBusyFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ORA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JNZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskYield<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,ReadPutPCB<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CALL</span><span class="tab" val="79"></span><span style="font: 10pt serif">ReadCPBuffer</span><span class="tab" val="79"></span><span style="font: 10pt serif">;Read CSB<br><br>{Move the IOCB address from the IOPage into the ReadBlock command.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutIocbAddressPointerLo</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutPCBAddressLo</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutIocbAddressPointerHi<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutPCBAddressHi<br><br>{Copy IOCB from main memory into IOP memory defined above.}<br>{NOTE: The IOCB should be in the IOPage. Then we won&rsquo;t have to copy it.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,PutIocbPCB<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CALL</span><span class="tab" val="79"></span><span style="font: 10pt serif">ReadCPBuffer<br><br>{Prepare to fetch the block of data from the CP. Copy the address of the data and the byte count from the IOCB into the Transfer ControlBlock.}<br>{NOTE: the IOCB should be in the format of a DmaControlBlock.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutBufferAddressLo</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBlockAddressLo<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutBufferAddressHi<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBlockAddressHi<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutByteCount</span><span class="tab" val="79"></span><span style="font: 10pt serif">; H,L contains number of bytes in block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutDataByteCount</span><span class="tab" val="79"></span><span style="font: 10pt serif">; Assume we will put that many bytes<br><br>{Check to see if the data will fit in the TxBuffer.}<br>{NOTE: The head should do this.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">D,TxBufferSize<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,E<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SUB</span><span class="tab" val="79"></span><span style="font: 10pt serif">L<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,D<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SBB</span><span class="tab" val="79"></span><span style="font: 10pt serif">H<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JM</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutBlockTooBig</span><span class="tab" val="79"></span><span style="font: 10pt serif">; Jump if block is too big</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br><br>{Calculate the address of the last character so the interrupt routine will know when it is finished.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">D,TxBuffer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DAD</span><span class="tab" val="79"></span><span style="font: 10pt serif">D<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DCX</span><span class="tab" val="79"></span><span style="font: 10pt serif">H</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;HL = last address<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,L</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">LastTxBufferAddressLow<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">LastTxBufferAddressLow1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,H<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">LastTxBufferAddressHigh<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">LastTxBufferAddressHigh1<br><br>{Initialize the instruction at PutFinishedSwitch. This gets modified by the interrupt routine when it sends the last byte.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MVI</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,opJNZ<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutFinishedSwitch<br><br>{Make sure the number of bytes is even.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutByteCount<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">INX</span><span class="tab" val="79"></span><span style="font: 10pt serif">H<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,L<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ANI</span><span class="tab" val="79"></span><span style="font: 10pt serif">0FEH<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">L,A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBlockByteCount<br><br>{Start the command to read the block from the CP.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,TxBlockPCB<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CALL</span><span class="tab" val="79"></span><span style="font: 10pt serif">StartCPReadDma<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,WaitForPutBlock<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">SavePutTaskResumeAddressAndYield<br><br>WaitForPutBlock:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CALL</span><span class="tab" val="79"></span><span style="font: 10pt serif">CheckCPDmaComplete<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskYield<br><br>{Now we have the data in memory. Perform initialization common to Async, Bisync, and Sdlc.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XRA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxUnderrunDetectedFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutCompletedFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,XferSuccess</span><span class="tab" val="79"></span><span style="font: 10pt serif">;Assume successful transfer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTransferStatus<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MVI</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,ResetTxCRCGenerator<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OUT</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxCont<br><br>{Jump to the appropriate routine. The following JMP address is modified by Misc when it processes a SetParameters command.}<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DB</span><span class="tab" val="79"></span><span style="font: 10pt serif">opJMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">;JMP PutAsyncMode<br>PutModeSwitch:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DW</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutAsyncMode<br>;</span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutAsyncMode<br>;</span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutBisyncMode<br>;</span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutSdlcMode}<br>;<br>PutBisyncMode:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XRA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">IllegalBisyncCharacterFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">RestartSIOCharacter<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DI<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutCompletedFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,TxBisyncInitial<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBisyncStateSwitch<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EI<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,TxBuffer</span><span class="tab" val="79"></span><span style="font: 10pt serif">;Initialize TxBufferPointer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBufferPointer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LDA</span><span class="tab" val="79"></span><span style="font: 10pt serif">CurrentSyncCount<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">SyncCharacterCount<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,8000H+TxCont<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LDA</span><span class="tab" val="79"></span><span style="font: 10pt serif">DisableTxCRC1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DI<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MVI</span><span class="tab" val="79"></span><span style="font: 10pt serif">M,PointToWR5<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">M,A</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;Disable CRC generator<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EI<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MVI</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,ModemSYN<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OUT</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxData</span><span class="tab" val="79"></span><span style="font: 10pt serif">; send the first byte to the chip<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,WaitForBisyncPut<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">SavePutTaskResumeAddressAndYield<br><br>WaitForBisyncPut:<br>{We won&rsquo;t get the first interrupt for TxBufferEmpty until we have sent one character. Wait for the interrupt routine to send all the rest of the characters. }<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DB</span><span class="tab" val="79"></span><span style="font: 10pt serif">opMVIA</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;A &larr; RestartSIOCharacter<br>RestartSIOCharacter:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DB</span><span class="tab" val="79"></span><span style="font: 10pt serif">0<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ORA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JNZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">PrimeSIO<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LDA</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutCompletedFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ORA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskYield<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DB</span><span class="tab" val="79"></span><span style="font: 10pt serif">opMVIA</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;A &larr; IllegalBisyncCharacterFlag<br>IllegalBisyncCharacterFlag:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DB</span><span class="tab" val="79"></span><span style="font: 10pt serif">0<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ORA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">TerminateTransmit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MVI</span><span class="tab" val="79"></span><span style="font: 10pt serif">L,InvalidCharacter<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">StoreErrorStatus<br><br>PrimeSIO:<br>{The interrupt routine wants us to prime the chip by sending a character. See if this is the filler character for end of frame.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CPI</span><span class="tab" val="79"></span><span style="font: 10pt serif">Filler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JNZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">RestartSIO<br><br>{If this is a filler character, wait until we get underrun. This means the CRC has been sent. We must not restart the chip until the CRC has been sent.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LDA</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxUnderrunDetectedFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ORA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskYield<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MVI</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,Filler<br><br>RestartSIO:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OUT</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxData</span><span class="tab" val="79"></span><span style="font: 10pt serif">; send the first byte to the chip<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XRA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">RestartSIOCharacter<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskYield<br>;<br>PutSdlcMode:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,TxBuffer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,M</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">; get the first character<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">INX</span><span class="tab" val="79"></span><span style="font: 10pt serif">H</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">; point to next byte<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBufferPointer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OUT</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxData</span><span class="tab" val="79"></span><span style="font: 10pt serif">; send the first byte to the chip<br><br>{When in Sdlc mode, we must reset the TxUnderRun/EOM flag after sending the first byte of message.  This causes the CRC to be sent at the end of the frame.}<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MVI</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,ResetTxEOM <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OUT</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxCont<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,WaitForSdlcPut<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">SavePutTaskResumeAddressAndYield<br><br>{Wait for the interrupt routine to send all the rest of the characters.}<br>WaitForSdlcPut:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DB</span><span class="tab" val="79"></span><span style="font: 10pt serif">opMVIA</span><span class="tab" val="79"></span><span style="font: 10pt serif">;A &larr; AbortPutFlag<br>AbortPutFlag:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DB</span><span class="tab" val="79"></span><span style="font: 10pt serif">0<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ORA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JNZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">AbortPut<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DB</span><span class="tab" val="79"></span><span style="font: 10pt serif">opORI</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;A &larr; TxUnderrunDetectedFlag<br>TxUnderrunDetectedFlag:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DB</span><span class="tab" val="79"></span><span style="font: 10pt serif">0<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskYield<br><br>{Continue if underrun has been detected. See if all the data has been transferred. If the Put did not complete, and we got an illegal transmit underrun, abort this frame.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LDA</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutCompletedFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ORA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JNZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">TestBufferEmpty<br><br>AbortPut:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MVI</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,SendAbort<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OUT</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxCont<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MVI</span><span class="tab" val="79"></span><span style="font: 10pt serif">L,Aborted<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">StoreErrorStatus<br><br>PutBlockTooBig:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MVI</span><span class="tab" val="79"></span><span style="font: 10pt serif">L,DeviceError<br><br>StoreErrorStatus:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MVI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,0</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;Zero success bit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTransferStatus<br><br>{Compute number of bytes actually sent: TxBufferPointer - TxBuffer.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBufferPointer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XCHG</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;DE &larr; TxBufferPointer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,TxBuffer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,D<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SUB</span><span class="tab" val="79"></span><span style="font: 10pt serif">L</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">;Subtract TxBuffer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">L,A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,E<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SBB</span><span class="tab" val="79"></span><span style="font: 10pt serif">H<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutDataByteCount<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">TerminateTransmit<br>;<br>PutAsyncMode:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,TxBuffer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MOV</span><span class="tab" val="79"></span><span style="font: 10pt serif">A,M</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">; get the first character<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">INX</span><span class="tab" val="79"></span><span style="font: 10pt serif">H</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">; point to next byte<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBufferPointer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OUT</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxData</span><span class="tab" val="79"></span><span style="font: 10pt serif">; send the first byte to the chip<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,WaitForAsyncPut<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">SavePutTaskResumeAddressAndYield<br><br>WaitForAsyncPut:<br>{We won&rsquo;t get the first interrupt for TxBufferEmpty until we have sent one character. Wait for the interrupt routine to send all the rest of the characters. It must be the case that we have sent all of the characters AND we have received the last interrupt from the chip. If we haven&rsquo;t received the last interrupt from the chip, there will still be a character in the transmit buffer, and it will not get sent until the next frame.}<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LDA</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutCompletedFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ORA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskYield</span><span class="tab" val="79"></span><span style="font: 10pt serif">; if not done<br><br>TestBufferEmpty:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IN</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxCont</span><span class="tab" val="79"></span><span style="font: 10pt serif">; Check to see if the buffer is empty<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ANI</span><span class="tab" val="79"></span><span style="font: 10pt serif">TxBufferEmpty<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskYield<br><br>TerminateTransmit:<br>{Send the processed IOCB back to the CP.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LDA</span><span class="tab" val="79"></span><span style="font: 10pt serif">PortBusyFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ORA</span><span class="tab" val="79"></span><span style="font: 10pt serif">A<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JZ</span><span class="tab" val="79"></span><span style="font: 10pt serif">ReturnPutIocb<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,TerminateTransmit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JMP</span><span class="tab" val="79"></span><span style="font: 10pt serif">SavePutTaskResumeAddressAndYield<br><br>ReturnPutIocb:<br>{Clear Put Abort flag in case it was set. This is used to signal the AbortOutput command in RS232CMisc that the task has completed.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">STA</span><span class="tab" val="79"></span><span style="font: 10pt serif">AbortPutFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,PutIocbPCB<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CALL</span><span class="tab" val="79"></span><span style="font: 10pt serif">WriteCPBuffer</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br><br>{Zero the PutFlag to indicate that the IOCB has been processed, and we are ready for another.}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,ZeroPutFlag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CALL</span><span class="tab" val="79"></span><span style="font: 10pt serif">WriteCPBuffer</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">RS232CTaskWakeMask<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CALL</span><span class="tab" val="79"></span><span style="font: 10pt serif">DoNakedNotify<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">LXI</span><span class="tab" val="79"></span><span style="font: 10pt serif">H,FetchPutIocb<br><br>SavePutTaskResumeAddressAndYield:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SHLD</span><span class="tab" val="79"></span><span style="font: 10pt serif">PutTaskResumeAddress<br>PutTaskYield:<br>{Pass control to the next task specified in Domino.cfg}<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DS</span><span class="tab" val="79"></span><span style="font: 10pt serif">0<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">END<br></span></div>
<script>function do_tabs() { // unit = px
  var tabs = document.getElementsByClassName("tab");
  for (var i = 0; i < tabs.length; ++i) {
    var span = tabs[i];
    var val = span.getAttribute("val");
    if (val == null) console.log("Couldn't get val");
    var rect = span.getBoundingClientRect();
    var tabstop;
    if (val > 0) tabstop = Math.ceil(rect.left / val) * val;
    else tabstop = -val;
    console.log("do_tabs", val, tabstop)
    if (tabstop > 0) {
      var width = tabstop - rect.left;
      span.style.display = "inline-block";
      span.style.width = width + "px";
    }
  }
}
do_tabs();
</script>
  </body>
</html>
