<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>[eris]&lt;Lisp>fugue.5>Sources>LISPDMC.DM!1>LSTACK.mc</title>
  </head>
  <body>
    <div style="width: 979pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt monospace">:Title[LSTACK.mc, December 7, 1982  3:42 PM, Masinter];<br><br>* STACK MANAGEMENT ROUTINES, COMMON INSTRUCTION TAILS<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">KnowRBase[LTEMP0];<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">TOP LEVEL;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">InsSet[LispInsSet, 1];<br><br>*--------------------------------------------------------------------<br>opMYALINK:<br>*--------------------------------------------------------------------<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">T&larr; (PVAR) - (FXBACK[ALINK]);<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">fetch&larr; T, T&larr; (177776c);<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">T&larr; T and Md;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">T&larr; T - (FX.PVAR), branch[PUSHSMALLT];<br><br><br>regOP1[146, StackBR, opMYALINK, noNData];<br><br>*--------------------------------------------------------------------<br></span><span style="font: 10pt serif">TL.ST0TMD:<br>   T&larr; Md, LTEMP0&larr; (store&larr; LTEMP0) + 1, dbuf&larr; T, branch[TL.ST0];<br></span><span style="font: 10pt monospace">*--------------------------------------------------------------------<br></span><span style="font: 10pt serif">TL.ST0:<br>   store&larr; LTEMP0, dbuf&larr; T, NextOpCode;<br><br></span><span style="font: 10pt monospace">*--------------------------------------------------------------------<br></span><span style="font: 10pt serif">TL.PUSHNIL:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">TSP&larr; (store&larr; TSP) + 1, dbuf&larr; AT.NIL, NextOpCode;</span></div>
<div style="width: 979pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"><br></span><span style="font: 10pt monospace">*--------------------------------------------------------------------<br></span><span style="font: 10pt serif">TL.PUSHTRUE:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">TSP&larr; (store&larr; TSP) + 1, dbuf&larr; AT.T, NextOpCode;<br><br></span><span style="font: 10pt monospace">*--------------------------------------------------------------------<br></span><span style="font: 10pt serif">TL.PUSHT:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">TSP&larr; (store&larr; TSP) + 1, dbuf&larr; T, NextOpCode;</span></div>
<div style="width: 979pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"><br></span><span style="font: 10pt monospace">*--------------------------------------------------------------------<br></span><span style="font: 10pt serif">TL.NOP:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">nop;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">NextOpCode;<br><br></span><span style="font: 10pt monospace">*--------------------------------------------------------------------<br></span><span style="font: 10pt serif">TL.DECTSP2: * after PCF&larr;, normally<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">TSP&larr; (TSP) - (2c);<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">NextOpCode;<br><br></span><span style="font: 10pt monospace">*--------------------------------------------------------------------<br></span><span style="font: 10pt serif">SUBROUTINE;<br><br>SUB.PUSHT:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">TSP&larr; (store&larr; TSP) + 1, dbuf&larr; T, return;<br><br></span><span style="font: 10pt monospace">*--------------------------------------------------------------------<br></span><span style="font: 10pt serif">TOP LEVEL;<br><br></span><span style="font: 10pt monospace">PUSHT0:<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.+2, R&gt;=0], </span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">&larr; (</span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">) - 1, memBase&larr; StackBR;<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">StackCheck;<br><br>:if[Debugging];<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">pd&larr; T and not (77c);<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.+2, alu=0];<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">uCodeCheck[</span><span style="font: 10pt serif">badpushval</span><span style="font: 10pt monospace">];<br>:endif;<br><br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">T&larr; (store&larr; TSP) + 1, dbuf&larr; T;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">TSP&larr; (store&larr; T) + 1, dbuf&larr; LTEMP0, NextOpCode;<br></span><span style="font: 10pt monospace">*--------------------------------------------------------------------<br></span><span style="font: 10pt monospace">PUSHSMALLT:<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.+2, R&gt;=0], </span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">&larr; (</span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">) - 1, memBase&larr; StackBR;<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">StackCheck;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">TSP&larr; (store&larr; TSP) + 1, dbuf&larr; SmallHi, branch[TL.PUSHT];<br></span><span style="font: 10pt monospace">*--------------------------------------------------------------------<br>PUSHTMD: <br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">PAGEFAULTNOTOK;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.+2, R&gt;=0], </span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">&larr; (</span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">) - 1, memBase&larr; StackBR;<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">StackCheck;<br></span><span style="font: 10pt monospace"><br>:if[Debugging];<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">pd&larr; T and not (77c);<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.+2, alu=0];<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">uCodeCheck[</span><span style="font: 10pt serif">badpushval</span><span style="font: 10pt monospace">];<br>:endif;<br><br></span><span style="font: 10pt monospace"><br>   T&larr; Md, TSP&larr; (store&larr; TSP) + 1, dbuf&larr; T, branch[TL.PUSHT];<br><br>*--------------------------------------------------------------------<br>:if[Debugging];<br>PUSHTQ: <br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">pd&larr; T and not (77c);<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.+2, alu=0];<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">uCodeCheck[</span><span style="font: 10pt serif">badpushval</span><span style="font: 10pt monospace">];<br></span><span style="font: 10pt monospace">PUSHTQOK: <br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.+2, R&gt;=0], </span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">&larr; (</span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">) - 1, memBase&larr; StackBR;<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">StackCheck;<br></span><span style="font: 10pt monospace"><br><br></span><span style="font: 10pt monospace">:else;<br>PUSHTQ: <br>PUSHTQOK: <br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.+2, R&gt;=0], </span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">&larr; (</span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">) - 1, memBase&larr; StackBR;<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">StackCheck;<br>:endif;<br></span><span style="font: 10pt monospace"><br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">TSP&larr; (store&larr; TSP) + 1, dbuf&larr; T;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">TSP&larr; (store&larr; TSP) + 1, dbuf&larr; Q, NextOpCode;<br><br>PUSH</span><span style="font: 10pt serif">QT</span><span style="font: 10pt monospace">: <br>PUSH</span><span style="font: 10pt serif">QT</span><span style="font: 10pt monospace">OK: <br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.+2, R&gt;=0], </span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">&larr; (</span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">) - 1, memBase&larr; StackBR;<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">StackCheck;<br></span><span style="font: 10pt monospace"><br>:if[Debugging];<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">LTEMP0&larr; Q;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">pd&larr; (LTEMP0) and not (77c);<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.+2, alu=0];<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">uCodeCheck[</span><span style="font: 10pt serif">badpushval</span><span style="font: 10pt monospace">];<br>:endif;<br><br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">TSP&larr; (store&larr; TSP) + 1, dbuf&larr; Q, branch[TL.PUSHT];<br><br>*--------------------------------------------------------------------<br>SUBROUTINE;<br><br>ADDSTK:</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">* called by FNCALL and MYFRAME when not enough stack<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">T&larr; (fetch&larr; ESP) + 1;</span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">* next stack word<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">T&larr; Md, fetch&larr; T;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">pd&larr; T xor (FreeStackBlock);<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace"> branch[.addstkFail, alu#0];<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">ESP&larr; (ESP) + (Md), branch[.mergefree];<br><br>FIXSTACKREGS:<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">memBase&larr; StackBR;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">PVAR&larr; (PVAR) - (sub[FX.PVAR!, FX.NEXT!]c);<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">PVAR&larr; (fetch&larr; PVAR) + (sub[FX.PVAR!, FX.NEXT!]c);<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">T&larr; ESP&larr; Md;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">TSP&larr; T, branch[.mergefree];<br><br><br>FIXLEFT:<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">T&larr; ESP, branch[.fixleft1];<br><br>.mergefree:<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">T&larr; (fetch&larr; ESP) + 1;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">T&larr; Md, fetch&larr; T;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">pd&larr; T xor (FreeStackBlock);<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.fixleft1, alu#0], T&larr; ESP;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">ESP&larr; (ESP) + (Md), branch[.mergefree];<br><br>.fixleft1:<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">&larr; T - (TSP);<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">&larr; (</span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">) rsh 1;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">&larr; (</span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">) - (</span><span style="font: 10pt serif">LEFT</span><span style="font: 10pt monospace">Offset), return;<br><br><br>TOP LEVEL;<br><br>.addstkFail:<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[</span><span style="font: 10pt serif">STKOVPUNT</span><span style="font: 10pt monospace">];<br><br>*--------------------------------------------------------------------<br>* REPTMD - replace value on top of stack with value in T,,MD<br>*--------------------------------------------------------------------<br>REPTMD:<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">memBase&larr; StackM2BR;<br></span><span style="font: 10pt monospace"><br>:if[Debugging];<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">pd&larr; T and not (77c);<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.+2, alu=0];<br></span><span class="tab" val="67"></span><span class="tab" val="67"></span><span style="font: 10pt monospace">uCodeCheck[</span><span style="font: 10pt serif">badpushval</span><span style="font: 10pt monospace">];<br>:endif;<br></span><span style="font: 10pt monospace"><br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">T&larr; Md, TSP&larr; (store&larr; TSP) + 1, dbuf&larr; T;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">TSP&larr; (store&larr; TSP) - 1, dbuf&larr; T, NextOpcode;<br><br><br><br><br>* ---- debugging subroutines<br><br>:if[Debugging];<br><br>SUBROUTINE;<br><br>CHECKPCXSUBR:<br></span><span style="font: 10pt serif">   pd&larr; (PSTATE) and (PS.PCXBAD);<br>   branch[.+2, alu#0];<br>   return;<br></span><span style="font: 10pt monospace"><br>   PSTATE&larr; Link;<br>TOP LEVEL;<br></span><span class="tab" val="67"></span><span style="font: 10pt serif">UCodeCheck[PuntInCall];<br></span><span style="font: 10pt monospace"><br>:endif;<br><br><br>:if[DebugEachInst];<br><br>SUBROUTINE;<br>DontKnowRBase;<br><br>*--------------------------------------------------------------------<br>NEXTOP: GLOBAL, * debug code that gets executed at the end of each instruction<br>*--------------------------------------------------------------------<br><br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">RBASE&larr;RBASE[PSTATE];<br><br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">PSTATE&larr; (PSTATE) and (not[PS.PCXBAD!]C);<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">branch[.+2, alu#0], LTEMP1&larr; Link;<br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">ifuJump[0];<br><br>TOP LEVEL;<br><br></span><span class="tab" val="67"></span><span style="font: 10pt monospace">UcodeCheck[];<br><br>:endif;<br></span></div>
<script>function do_tabs() { // unit = px
  var tabs = document.getElementsByClassName("tab");
  for (var i = 0; i < tabs.length; ++i) {
    var span = tabs[i];
    var val = span.getAttribute("val");
    if (val == null) console.log("Couldn't get val");
    var rect = span.getBoundingClientRect();
    var tabstop;
    if (val > 0) tabstop = Math.ceil(rect.left / val) * val;
    else tabstop = -val;
    console.log("do_tabs", val, tabstop)
    if (tabstop > 0) {
      var width = tabstop - rect.left;
      span.style.display = "inline-block";
      span.style.width = width + "px";
    }
  }
}
do_tabs();
</script>
  </body>
</html>
